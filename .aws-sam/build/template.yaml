AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'Serverless application with two API Gateways: OP Gateway for Authorization
  Server (AS) with mTLS, and mock-telco-o Gateway for the Trust Score API.

  '
Globals:
  Function:
    Timeout: 30
    Runtime: nodejs18.x
    MemorySize: 128
Parameters:
  OPCertificateArn:
    Type: String
    Default: arn:aws:acm:ap-southeast-2:615299729910:certificate/c8c989fd-1eec-4a88-913e-19bb202acda5
    Description: The ACM certificate ARN for sandbox.as.trustframeworks.io.
  MockTelcoCertificateArn:
    Type: String
    Default: arn:aws:acm:ap-southeast-2:615299729910:certificate/9f2a8df4-841c-46c9-b585-84f09afc8613
    Description: The ACM certificate ARN for mock-telco-o.api.trustframeworks.io.
Resources:
  CACertificateBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName:
        Fn::Sub: ca-certificate-bucket-${AWS::AccountId}-${AWS::Region}
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
  OPFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: OPFunction
      Handler: app.handler
      Environment:
        Variables:
          ISSUER_URL:
            Fn::Join:
            - ''
            - - https://
              - Fn::GetAtt:
                - OPDomain
                - DomainName
      Events:
        OPAPI:
          Type: Api
          Properties:
            RestApiId:
              Ref: OPGateway
            Path: /op
            Method: ANY
    Metadata:
      SamResourceId: OPFunction
  TrustScoreFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: TrustScoreFunction
      Handler: app.handler
      Environment:
        Variables:
          JWT_ISSUER: telcoexample.com
      Events:
        TrustScoreAPI:
          Type: Api
          Properties:
            RestApiId:
              Ref: MockTelcoGateway
            Path: /trust-score
            Method: POST
    Metadata:
      SamResourceId: TrustScoreFunction
  OPGateway:
    Type: AWS::Serverless::Api
    Properties:
      StageName: Prod
      Domain:
        DomainName: sandbox.as.trustframeworks.io
        CertificateArn:
          Ref: OPCertificateArn
        MutualTlsAuthentication:
          TruststoreUri:
            Fn::Sub: s3://${CACertificateBucket}/certs/ca.crt
          TruststoreVersion: '1'
  MockTelcoGateway:
    Type: AWS::Serverless::Api
    Properties:
      StageName: Prod
      Domain:
        DomainName: mock-telco-o.api.trustframeworks.io
        CertificateArn:
          Ref: MockTelcoCertificateArn
  OPDomain:
    Type: AWS::ApiGateway::DomainName
    Properties:
      DomainName: sandbox.as.trustframeworks.io
      RegionalCertificateArn:
        Ref: OPCertificateArn
      EndpointConfiguration:
        Types:
        - REGIONAL
  MockTelcoDomain:
    Type: AWS::ApiGateway::DomainName
    Properties:
      DomainName: mock-telco-o.api.trustframeworks.io
      RegionalCertificateArn:
        Ref: MockTelcoCertificateArn
      EndpointConfiguration:
        Types:
        - REGIONAL
  SandboxASRecordSet:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: Z04859113RMVSAYT46EAR
      Name: sandbox.as.trustframeworks.io
      Type: A
      AliasTarget:
        DNSName:
          Fn::GetAtt:
          - OPDomain
          - RegionalDomainName
        HostedZoneId:
          Fn::GetAtt:
          - OPDomain
          - RegionalHostedZoneId
  MockTelcoRecordSet:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: Z04859113RMVSAYT46EAR
      Name: mock-telco-o.api.trustframeworks.io
      Type: A
      AliasTarget:
        DNSName:
          Fn::GetAtt:
          - MockTelcoDomain
          - RegionalDomainName
        HostedZoneId:
          Fn::GetAtt:
          - MockTelcoDomain
          - RegionalHostedZoneId
Outputs:
  OPGatewayURL:
    Description: URL for OpenID Provider API Gateway (mTLS enabled)
    Value:
      Fn::Join:
      - ''
      - - https://
        - Fn::GetAtt:
          - OPDomain
          - DomainName
        - /Prod/op
  MockTelcoGatewayURL:
    Description: URL for mock-telco-o API Gateway hosting the Trust Score API
    Value:
      Fn::Join:
      - ''
      - - https://
        - Fn::GetAtt:
          - MockTelcoDomain
          - DomainName
        - /Prod/trust-score
